schema: '2.0'
stages:
  prepare:
    cmd: python3 src/prepare.py
    deps:
    - path: data/raw
      hash: md5
      md5: 362a2786d88d0e9de21676c5045a776e.dir
      size: 8094939561
      nfiles: 10
    - path: src/methods/prepare/tiling_ann_simple.py
      hash: md5
      md5: 878e1392067a249fbfdb52c23d677ea7
      size: 7173
    - path: src/prepare.py
      hash: md5
      md5: 5a154ecd96cd32a51c9fae28429fed69
      size: 578
    params:
      params.yaml:
        prepare.method: tiling_ann_simple
        prepare.tiling_ann_simple:
          tile_size: 448
          tile_overlap: 0.5
          tile_output_size: 320
    outs:
    - path: data/prepared
      hash: md5
      md5: 8b19ca27d5589ac80602830fcc21747d.dir
      size: 6275468015
      nfiles: 4
  preprocess:
    cmd: python3 src/preprocess.py
    deps:
    - path: data/prepared
      hash: md5
      md5: 8b19ca27d5589ac80602830fcc21747d.dir
      size: 6275468015
      nfiles: 4
    - path: src/methods/preprocess/generate_dataset.py
      hash: md5
      md5: 472a70b532ea30be2018a2e73e11a5b0
      size: 4446
    - path: src/preprocess.py
      hash: md5
      md5: 59661d58a752c8ed329e6f6b821c8746
      size: 735
    params:
      params.yaml:
        preprocess.generate_dataset:
          metadata_path: data/prepared/metadata.csv
          image_sim_path: data/prepared/similarity_map.csv
          lake_image_ratio: 0.7
          seed: 412
          img_path: data/prepared/tiles
          ann_path: data/prepared/ann_tiles
        preprocess.method: generate_dataset
    outs:
    - path: data/preprocessed/
      hash: md5
      md5: 88c14414d5c02fc97ee5b6d06e894790.dir
      size: 1931139167
      nfiles: 33467
  process:
    cmd: python3 src/process_ptl_unet.py
    deps:
    - path: data/preprocessed/dataset.csv
      hash: md5
      md5: 005fd8f52816430f0e4eb7117ce0c009
      size: 2736256
    - path: src/process_ptl_unet.py
      hash: md5
      md5: 8b0390cf6bd5b502884e0da783bb6341
      size: 5956
    params:
      params.yaml:
        process.ptl_unet:
          seed: 412
          dataset_path: data/preprocessed/dataset.csv
          split: 1
          batch_size: 32
          acc_grad_batches: 1
          precision: 32-true
          metric_monitor: train_iou_loss
          use_best_ckpt: false
          es_patience:
          lr: 0.00015
          lr_step_size: 20
          lr_gamma: 0.8
          tversky_alpha: 0.4
          tversky_beta: 0.6
          lake_loss_gamma: 0.25
          epochs: 140
          num_workers: 32
    outs:
    - path: lightning_logs
      hash: md5
      md5: 541208ec5635d4d0b510d8c4565744a6.dir
      size: 783913650
      nfiles: 4
    - path: out/model.ckpt
      hash: md5
      md5: 3488c1942a37a3ed7b3b2e1778957ee7
      size: 391910639
  extract:
    cmd: python3 src/extract.py
    deps:
    - path: out/model.ckpt
      hash: md5
      md5: 3488c1942a37a3ed7b3b2e1778957ee7
      size: 391910639
    - path: src/extract.py
      hash: md5
      md5: a8a7cd97248745999f76c5e820d9ccfb
      size: 710
    - path: src/methods/extract/extract_border.py
      hash: md5
      md5: 4c73a0706803cefb817e9f3b7e9ffbd9
      size: 9821
    params:
      params.yaml:
        extract.extract_border:
          overlap_cnt: 2
        extract.method: extract_border
    outs:
    - path: out/lake_polygons_pred.gpkg
      hash: md5
      md5: 5d9267a5f06d3241b1c482357d7f4ec5
      size: 11206656
  postprocess:
    cmd: python3 src/postprocess.py
    deps:
    - path: out/lake_polygons_pred.gpkg
      hash: md5
      md5: 5d9267a5f06d3241b1c482357d7f4ec5
      size: 11206656
    - path: src/postprocess.py
      hash: md5
      md5: 4a88c82ddbf264573a71ef90346e67d0
      size: 825
    outs:
    - path: out/lake_polygons_pred_clean.gpkg
      hash: md5
      md5: 03c2a862c2c4331701c5174aa5da9a46
      size: 11022336
  evaluate:
    cmd: python3 src/evaluate.py
    deps:
    - path: out/lake_polygons_pred_clean.gpkg
      hash: md5
      md5: 03c2a862c2c4331701c5174aa5da9a46
      size: 11022336
    - path: src/evaluate.py
      hash: md5
      md5: 793d9a47547e7279eac8ec3e6b97dee9
      size: 11677
    params:
      params.yaml:
        images:
        - Greenland26X_22W_Sentinel2_2019-06-03_05.tif
        - Greenland26X_22W_Sentinel2_2019-06-19_20.tif
        - Greenland26X_22W_Sentinel2_2019-07-31_25.tif
        - Greenland26X_22W_Sentinel2_2019-08-25_29.tif
        training_data_regions:
          Greenland26X_22W_Sentinel2_2019-06-03_05.tif:
          - 2
          - 4
          - 6
          Greenland26X_22W_Sentinel2_2019-06-19_20.tif:
          - 1
          - 3
          - 5
          Greenland26X_22W_Sentinel2_2019-07-31_25.tif:
          - 2
          - 4
          - 6
          Greenland26X_22W_Sentinel2_2019-08-25_29.tif:
          - 1
          - 3
          - 5
    outs:
    - path: evaluation/plots
      hash: md5
      md5: 997deebf0c855b2a1b9fb4f941d1ce6c.dir
      size: 8304332
      nfiles: 12
    - path: evaluation/summary.json
      hash: md5
      md5: fb45dbe57852e43b4c1e468f364bedac
      size: 2611
  submission:
    cmd: python3 src/submission.py
    deps:
    - path: out/lake_polygons_pred_clean.gpkg
      hash: md5
      md5: 03c2a862c2c4331701c5174aa5da9a46
      size: 11022336
    - path: src/submission.py
      hash: md5
      md5: 46eae51d41818ed8b95eb6899e36fefa
      size: 3784
    outs:
    - path: GPKG/lake_polygons_test.gpkg
      hash: md5
      md5: 89fee593c9727a157b8736a404d62d01
      size: 5595136
